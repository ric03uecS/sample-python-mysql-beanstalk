language: python

python:
  - 2.7

env:
  global:
    - RDS_HOSTNAME=127.0.0.1 RDS_USERNAME=shippable RDS_PASSWORD="" RDS_DB_NAME=test RDS_PORT=3306
    - AWSAccessKeyId=AKIAJJL2U6T3F3Y5JIGA
    - secure: CuB5DNTxuXq60T1+YHFgIWJiOrRZ/ct5kLmxAuuF5mrZPfYvFuysvp5N6oFWyAUvA+MXo0VZg/LHuaAEcnyTRWizHtbgh7fVBgyXnQeO8PgiMq3V+GqyNrnR+qxc+SklS3q5fsZiP1czzKTaMMhMBdYoRm2KLoGDWr3UcwNMqga3qUC3q6amZxl0I/XRN+yRy15tD13/2JUTkWLO+TDhfTLcMHU3hHjZDTnUvNz5Co6dFeUWK/MlTpV1mSF0m0HqWIs/qevu/x+XQnDW+Jy81qbKXXFEmrO7qRrXK6EB1dY3IM2QX14Y84Meaj8C1/eErdJwAk2wUu0AGmc0f0CkfQ==
    

before_install:
- SUDO=$(which sudo) && $SUDO pip install awsebcli
  
install:
  - pip install -r requirements.txt

before_script: 
  - mkdir -p shippable/testresults
  - mkdir -p shippable/codecoverage
  - mysql -e 'create database if not exists test;'
  - mkdir -p ~/.aws
  - echo '[profile eb-cli]' > ~/.aws/config
  - echo "aws_access_key_id = $AWSAccessKeyId" >> ~/.aws/config
  - echo "aws_secret_access_key = $AWSSecretKey" >> ~/.aws/config

script:
  - mkdir -p .elasticbeanstalk
  - cp config.yml .elasticbeanstalk/
  - nosetests test.py --with-xunit --xunit-file=shippable/testresults/nosetests.xml
  - which python && coverage run --branch test.py
  - which python && coverage xml -o shippable/codecoverage/coverage.xml test.py

after_success:
  - eb init && eb deploy
